name: Build and Release DiceSensei

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest requests psutil
    
    - name: Run tests
      run: |
        if [ -d "tests" ]; then
          python -m pytest tests/ -v --tb=short
        else
          echo "No tests directory found, skipping tests"
        fi

  build-windows:
    name: Build Windows
    needs: test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable
      run: |
        pyinstaller --name=DiceSensei --onefile --windowed --paths=src --add-data="assets;assets" --add-data="config;config" --icon=assets/icons/dicesensei.ico src/main.py
    
    - name: Verify build
      run: |
        if (Test-Path "dist/DiceSensei.exe") {
          Write-Host "‚úÖ Build successful: DiceSensei.exe created"
          Get-Item dist/DiceSensei.exe | Format-List
        } else {
          Write-Error "‚ùå Build failed: DiceSensei.exe not found"
          exit 1
        }
    
    - name: Create Windows package
      run: |
        New-Item -ItemType Directory -Force -Path releases/windows
        Copy-Item dist/DiceSensei.exe releases/windows/
        Copy-Item -Recurse assets releases/windows/
        Copy-Item -Recurse config releases/windows/
        Copy-Item README.md releases/windows/
        Copy-Item LICENSE releases/windows/
        
        # Copy installer files if they exist
        if (Test-Path "installer/install_windows.ps1") {
          Copy-Item installer/install_windows.ps1 releases/windows/
        }
        if (Test-Path "installer/DiceSensei_Certificate.cer") {
          Copy-Item installer/DiceSensei_Certificate.cer releases/windows/
        }
        if (Test-Path "installer/install_windows.bat") {
          Copy-Item installer/install_windows.bat releases/windows/
        }
        
        # Create simple launcher batch file
        @"
        @echo off
        echo Starting DiceSensei...
        start "" "%~dp0DiceSensei.exe"
        "@ | Out-File -FilePath releases/windows/launch.bat -Encoding ASCII
    
    - name: Create ZIP package
      run: |
        Compress-Archive -Path releases/windows/* -DestinationPath dicesensei-windows.zip -Force
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: dicesensei-windows
        path: dicesensei-windows.zip
        retention-days: 1

  build-linux:
    name: Build Linux
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        sudo apt-get update
        sudo apt-get install -y p7zip-full
    
    - name: Build executable
      run: |
        pyinstaller --name=dicesensei --onefile --paths=src --add-data='assets:assets' --add-data='config:config' src/main.py
    
    - name: Verify build
      run: |
        if [ -f "dist/dicesensei" ]; then
          echo "‚úÖ Build successful: dicesensei created"
          ls -lh dist/dicesensei
        else
          echo "‚ùå Build failed: dicesensei not found"
          exit 1
        fi
    
    - name: Create Linux package
      run: |
        mkdir -p releases/linux
        cp dist/dicesensei releases/linux/
        cp -r assets releases/linux/
        cp -r config releases/linux/
        cp README.md releases/linux/
        cp LICENSE releases/linux/
        
        # Copy installer if exists
        if [ -f "installer/install_linux.sh" ]; then
          cp installer/install_linux.sh releases/linux/
          chmod +x releases/linux/install_linux.sh
        fi
        
        chmod +x releases/linux/dicesensei
        
        # Create launch script
        cat > releases/linux/launch.sh << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"
        ./dicesensei
        EOF
        chmod +x releases/linux/launch.sh
    
    - name: Create ZIP package
      run: |
        cd releases/linux
        zip -r ../../dicesensei-linux.zip *
        cd ../..
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: dicesensei-linux
        path: dicesensei-linux.zip
        retention-days: 1

  build-macos:
    name: Build macOS
    needs: test
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable
      run: |
        # Build without icon first to avoid icon errors
        pyinstaller --name=DiceSensei --onefile --windowed --paths=src --add-data='assets:assets' --add-data='config:config' src/main.py
    
    - name: Verify build
      run: |
        if [ -f "dist/DiceSensei" ]; then
          echo "‚úÖ Build successful: DiceSensei created"
          ls -lh dist/DiceSensei
        else
          echo "‚ùå Build failed: DiceSensei not found"
          exit 1
        fi
    
    - name: Create macOS package
      run: |
        mkdir -p releases/macos
        cp dist/DiceSensei releases/macos/
        cp -r assets releases/macos/
        cp -r config releases/macos/
        cp README.md releases/macos/
        cp LICENSE releases/macos/
        
        # Copy installer if exists
        if [ -f "installer/install_macos.sh" ]; then
          cp installer/install_macos.sh releases/macos/
          chmod +x releases/macos/install_macos.sh
        fi
        
        chmod +x releases/macos/DiceSensei
        
        # Create launch script
        cat > releases/macos/launch.sh << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"
        ./DiceSensei
        EOF
        chmod +x releases/macos/launch.sh
    
    - name: Create ZIP package
      run: |
        cd releases/macos
        zip -r ../../dicesensei-macos.zip *
        cd ../..
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: dicesensei-macos
        path: dicesensei-macos.zip
        retention-days: 1

  release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Organize artifacts
      run: |
        mkdir -p release_files
        find artifacts -name "*.zip" -exec cp {} release_files/ \;
        ls -la release_files/
    
    - name: Generate checksums
      run: |
        cd release_files
        sha256sum *.zip > checksums.sha256
        echo "=== Generated checksums ==="
        cat checksums.sha256
    
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release_files/*.zip
          release_files/checksums.sha256
        body: |
          # üé≤ DiceSensei ${{ steps.get_version.outputs.version }}
          
          **Asistente de Estudio Inteligente con IA Local**
          
          ## üì¶ Descargas
          
          | Sistema | Archivo | Tama√±o |
          |---------|---------|--------|
          | ü™ü Windows | [dicesensei-windows.zip](../../releases/download/${{ steps.get_version.outputs.version }}/dicesensei-windows.zip) | ~50 MB |
          | üêß Linux | [dicesensei-linux.zip](../../releases/download/${{ steps.get_version.outputs.version }}/dicesensei-linux.zip) | ~50 MB |
          | üçé macOS | [dicesensei-macos.zip](../../releases/download/${{ steps.get_version.outputs.version }}/dicesensei-macos.zip) | ~50 MB |
          
          ## üîí Verificaci√≥n de Integridad
          
          Descarga [`checksums.sha256`](../../releases/download/${{ steps.get_version.outputs.version }}/checksums.sha256) y verifica:
          
          ```bash
          # Linux/macOS
          sha256sum -c checksums.sha256
          
          # Windows (PowerShell)
          Get-FileHash dicesensei-windows.zip -Algorithm SHA256
          ```
          
          ## üöÄ Instalaci√≥n R√°pida
          
          ### Windows
          1. Extrae `dicesensei-windows.zip`
          2. **Opci√≥n A (Recomendada)**: 
             - Instala el certificado: doble clic en `DiceSensei_Certificate.cer`
             - Ejecuta `install_windows.ps1` (clic derecho ‚Üí "Ejecutar con PowerShell")
          3. **Opci√≥n B**: Ejecuta directamente `DiceSensei.exe`
          
          ### Linux
          ```bash
          unzip dicesensei-linux.zip
          cd dicesensei-linux
          chmod +x dicesensei
          ./dicesensei
          ```
          
          ### macOS
          ```bash
          unzip dicesensei-macos.zip
          cd dicesensei-macos
          chmod +x DiceSensei
          ./DiceSensei
          ```
          
          ## ‚ö†Ô∏è Nota para Antivirus
          
          Los instaladores pueden ser detectados como falsos positivos. Es seguro:
          - ‚úÖ C√≥digo 100% open source
          - ‚úÖ Sin telemetr√≠a
          - ‚úÖ Sin conexiones externas (excepto descargas iniciales)
          
          Si tu antivirus lo bloquea, a√±ade una excepci√≥n para la carpeta de DiceSensei.
          
          ## üìö Documentaci√≥n
          
          - [README completo](../../blob/main/README.md)
          - [Gu√≠a de instalaci√≥n](../../blob/main/docs/installation.md)
          - [Soluci√≥n de problemas](../../blob/main/docs/troubleshooting.md)
          
          ## üÜï Novedades en esta versi√≥n
          
          - Release inicial de DiceSensei
          - Soporte para PDF, Word, TXT y Markdown
          - Chat con IA completamente offline
          - Optimizaci√≥n autom√°tica de hardware
          
          ---
          
          **¬øProblemas?** Abre un [issue](../../issues) o consulta la [documentaci√≥n](../../blob/main/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}